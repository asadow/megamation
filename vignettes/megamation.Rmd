---
title: "megamation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{megamation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
can_decrypt <- httr2::secret_has_key("HTTR2_KEY")
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  error = TRUE,
  eval = can_decrypt
)
```

```{r eval = !can_decrypt, echo = FALSE, comment = NA}
message("No token available. Code chunks will not be evaluated.")
```

```{r, include = FALSE}
library(httptest2)
start_vignette("megamation")
```

```{r}
library(megamation)
```

## Authorize

`mm_set_creds()` installs your API credentials in your `.Renviron`, a safe place for secrets.

`mm_get()` gets the data and automatically uses these credentials.

```{r}
mm_get("status")
```

## Supply Filters

`mm_get()` takes name-value pairs to filter and speed up your request. It always returns a tibble. (Here, we show only the R code for privacy of data.)

```{r, eval = FALSE}
mm_get("workorder", building_id = c("001", "002"))
```

The values can be prefixed by Megamation's [modifiers](https://apidocs.megamation.com/):

- `[]` for containing

- `!!` for not equal

- `>>` for greater than

- `<<` for less than

- `<>` for between.

```{r, eval = FALSE}
mm_get("workorder", trade = c("[]PCO", "[]DM"))
```

Instead of using `<>` for dates, use a sequence of dates:

```{r}
jan_2023 <- seq.Date(
  as.Date("2023-01-01"),  
  as.Date("2023-01-31"), 
  by = "day"
  )
```

```{r, eval = FALSE}
mm_get("workorder", date = jan_2023)
```

## `mm_get()` Internals

`mm_get()` uses four main functions: 

- `mm_request()` to create a request.
- `mm_req_perform()` to perform a request and return the response.
- `mm_resp_parse()` to parse the response.
- `parsed_extract()` to extract data from the parsed response.

### Define the Request

`mm_request()` prints the request without performing it:

```{r}
req <- mm_request("workorder", date = jan_2023)
req
```

### Perform the Request

`mm_req_perform()` performs a request and returns a list of API responses.

```{r}
resp <- mm_request("status") |> 
  mm_req_perform()
resp
```

### Parse the Response

 `mm_resp_parse()` parses the body of a response, which contains raw bytes, and returns a list.

```{r}
parsed <- resp[[1]] |>
  mm_resp_parse()
parsed
```

### Extract Data From the Parsed Response

`parsed_extract()` extracts the data of interest from a parsed body.

```{r}
.data <- parsed |>
  parsed_extract()
.data
```

```{r, include = FALSE}
end_vignette()
```
