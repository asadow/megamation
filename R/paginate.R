#' Add pagination to a Megamation API request
#' @param req An API request generated by [mm_req()] or [httr2::req()].
#' @export
mm_req_paginate <- function(req) {
  req |>
    httr2::req_paginate_next_url(
      parse_resp = function(resp) {
        parsed <- resp |>
          httr2::resp_body_raw() |>
          body_parse()

        parsed$next_url <- if (parsed$next_page == "") {
          NULL
          }
        else (parsed$next_page)
        list(data = list(resp), next_url = parsed$next_url)
      },
      n_pages = function(parsed) {
        sub(".*_", "", parsed$page_count) |> as.numeric()
      }
    )
}

# Custom Method -----------------------------------------------------------

#' Add pagination to a Megamation API request
#' @param req An API request generated by [mm_req()] or [httr2::req()].
#' @export
mm_req_paginate_custom <- function(req) {
  req |>
    httr2::req_paginate(
      next_request = function(req, parsed) {
        if (parsed$next_page == "") return(NULL)
        req |> httr2::req_url(parsed$next_page)
      }
    )
}

# Importing rlang's null default operator
`%||%` <- rlang::`%||%`

#' Perform a paginated request
#' @param req An API request generated by [mm_req()] with pagination from
#' [mm_req_paginate()].
#' @param max_pages Max number of pages to request.
#' @export
mm_req_perform_paginate_custom <- function(req, max_pages = NULL) {
  out <- vector("list", max_pages %||% 10)
  i <- 1L

  repeat({
    out[[i]] <- httr2::req_perform(req) |> body_parse()
    if (!is.null(max_pages) && i == max_pages) {
      break
    }

    req <- req |> httr2::paginate_next_request(parsed = out[[i]])

    if (is.null(req)) {
      break
    }

    i <- i + 1L
    if (i > length(out)) {
      length(out) <- length(out) * 2L
    }
  })

  if (i != length(out)) {
    out <- out[seq_len(i)]
  }
  out

}
